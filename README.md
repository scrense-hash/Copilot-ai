# Autorouter Service

Autorouter — это OpenAI-совместимый прокси, который интеллектуально перенаправляет запросы к различным модельм через OpenRouter.

## Ключевые особенности

- **Автоматический выбор модели**: Выбирает лучшую модель на основе длины контекста, цены и поддержки инструментов
- **Умный фолбэк**: Автоматически повторяет попробовать с альтернативными моделями при сбоях
- **Предварительная буферизация SSE**: Валидирует и буферизирует потоки перед пересылкой для предотвращения ошибок клиентов
- **Нормализация вызовов инструментов**: Конвертирует встроенные разметки инструментов в структурированный формат API
- **Комплексное логирование**: Полная трассировка запросов с корреляцией по req_id
- **Системный промпт роутера**: Глобальная инъекция промпта для всех запросов
- **Кэширование моделей**: Автоматическое обновление с настраиваемыми интервалами
- **Отладка трафика**: Опциональное подробное логирование SSE трафика

## Архитектура

```
Запрос → FastAPI → Выбор модели → Клиент API → OpenRouter API
          ↓              ↓              ↓              ↓
        Вставка     Фильтрация   Сопоставление   Валидация
     системного    (контекст/   ID инструментов   потока
       промпта       цена/                     & буферизация
                    запреты)
```

**Основные компоненты:**
- `autorouter_service.py`: Приложение FastAPI с управлением жизненным циклом
- `config.py`: Конфигурация на основе окружения с валидацией
- `models.py`: ModelCache и ModelSelector для интеллектуальной маршрутизации
- `upstream.py`: UpstreamClient для коммуникации с API OpenRouter
- `sse_handler.py`: SSEValidator и SSEStreamer для надежного стриминга
- `logger.py`: Конфигурация логирования с опциональными цветами
- `utils.py`: Вспомогательные функции

## Быстрый старт

### 1. Установка зависимостей
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r tests/requirements-dev.txt
```

### 2. Конфигурация окружения
```bash
export OPENROUTER_API_KEY="sk-or-v1-..."
export MIN_CTX=131072
export MAX_PRICE=0.0
export BUFFER_STREAM_KEEPALIVE_S=5.0
export MAX_BUFFERED_SSE_BYTES=20000000
export STREAM_IDLE_TIMEOUT_S=20.0

### 3. Запуск сервиса
```bash
python autorouter_service.py
```

### 4. Проверка
```bash
curl http://localhost:8000/healthz
curl http://localhost:8000/v1/models
```

## API Endpoints

### POST /v1/chat/completions
OpenAI-совместимый чат с автоматической маршрутизацией модели.

**Запрос:**
```json
{
  "model": "copilot-autorouter",
  "messages": [{"role": "user", "content": "Привет!"}],
  "stream": true
}
```

### GET /v1/models
Возвращает информацию о виртуальной модели.

### GET /healthz
Проверка работоспособности.

### GET /logs
Веб-интерфейс для просмотра логов с поддержкой ANSI цветов, автообновлением и функцией скачивания.

### GET /debug/traffic
Проверка логирования трафика.

## Конфигурация

Ключевые переменные:
- `OPENROUTER_API_KEY`: Ваш API-ключ (обязательно)
- `MIN_CTX`: Минимальная длина контекста (по умолчанию 131072)
- `MAX_PRICE`: Лимит цены за 1M токенов (по умолчанию 0.0 - только бесплатные)
- `PRIORITY_MODELS`: Приоритетные модели через запятую
- `BAN_MODELS`: Забаненные модели через запятую
- `BUFFER_STREAM_KEEPALIVE_S`: Интервал keepalive для буферизованного потока (по умолчанию 5.0)
- `MAX_BUFFERED_SSE_BYTES`: Максимальный размер буфера SSE в байтах (по умолчанию 20000000)
- `STREAM_IDLE_TIMEOUT_S`: Таймаут простоя потока в секундах (по умолчанию 20.0)
- `LOG_LEVEL`: Уровень логирования (по умолчанию INFO)
- `DEBUG_SSE_TRAFFIC`: Включить подробное логирование SSE (по умолчанию false)
- `ROUTER_SYSTEM_PROMPT`: Системный промпт для инъекции (загружается из router_prompt.txt)

Дополнительные параметры стриминга:
- `STREAM_PREFORWARD_MIN_DATA`: Минимальное количество SSE событий для предварительной отправки (по умолчанию 2)
- `STREAM_PREFORWARD_WINDOW_S`: Временное окно для предварительной отправки SSE событий (по умолчанию 1.5)
- `ATTEMPT_DEADLINE_NONSTREAM_S`: Предельное время попытки нестримингового запроса в секундах (по умолчанию 20.0)

Параметры временных банов:
- `INLINE_TOOL_BAN_TTL_S`: TTL для банов за inline tool markup (по умолчанию 21600 сек - 6 часов)
- `EARLY_EOF_BAN_TTL_S`: TTL за досрочный EOF (по умолчанию 900 сек - 15 минут)

Параметры отладки SSE трафика:
- `DEBUG_SSE_TRAFFIC_LOG_PATH`: Путь к файлу логов SSE (по умолчанию traffic_sse.log)
- `DEBUG_SSE_TRAFFIC_TRUNCATE_BYTES`: Размер обрезки сообщений (по умолчанию 0 - без обрезки)
- `DEBUG_SSE_TRAFFIC_MAX_BYTES`: Максимальный размер файла лога (по умолчанию 100000000)
- `DEBUG_SSE_TRAFFIC_BACKUP_COUNT`: Количество резервных файлов (по умолчанию 3)
- `DEBUG_SSE_TRAFFIC_MIRROR_MAIN`: Зеркалировать в основной лог (по умолчанию true)
- `DEBUG_SSE_TRAFFIC_MIRROR_MAIN_MAX_CHUNKS`: Лимит чанков для зеркалирования (по умолчанию 5)

Смотрите ENV_PARAMS_RU.md для полной документации.

## Процесс выбора модели

1. Получение моделей из OpenRouter
2. Фильтрация: поддержка инструментов + контекст >= MIN_CTX + цена <= MAX_PRICE + не забанены
3. Сортировка: приоритет сначала, затем цена низкая, затем контекст высокий
4. Попытка с фолбэком при сбое

## Потоковая обработка (SSE)

### Режимы работы:
- **Буферизованный поток** (default для virtual model): Сервер буферизует весь ответ от upstream до получения `[DONE]`, затем нормализует и отправляет клиенту. Это предотвращает ошибки клиентов из-за некорректных SSE форматов.
- **Прямой поток** (для explicit upstream models): Данные передаются сразу, но с валидацией первого события.

### Безопасность потоков:
- **Prebuffering**: Первые события проверяются перед началом передачи
- **Watchdog**: Закрывает соединение при простоях (> `STREAM_IDLE_TIMEOUT_S`)
- **Валидация встроенных инструментов**: Обнаружение и бан моделей с inline tool markup
- **Обработка досрочного EOF**: Бан моделей, закрывающих поток без `[DONE]`

## Нормализация вызовов инструментов AutoRouter

Некоторые модели возвращают вызовы инструментов в виде inline markup:
```xml
<tool_call>
  <function name="get_weather">
    <parameter name="city">Moscow</parameter>
  </function>
</tool_call>
```
AutoRouter нормализует это в стандартный формат:
```json
{
  "tool_calls": [
    {
      "id": "TLCLcpcErK",
      "function": {
        "arguments": "{\"city\": \"Moscow\"}",
        "name": "get_weather"
      },
      "type": "function"
    }
  ]
}
```

## Отслеживание трафика SSE

С помощью `DEBUG_SSE_TRAFFIC` можно включить подробное логирование трафика SSE для отладки.
Логи записываются в `traffic_sse.log`.

## Логирование

Сервис использует библиотеку loguru для логирования.
Все логи записываются в директорию `logs`.
Доступен веб-интерфейс для просмотра логов по адресу `/logs`.

## Тестирование

Для запуска тестов выполните `./run_tests.sh -c`.
Используются pytest и pytest-cov для проверки покрытия кода.
